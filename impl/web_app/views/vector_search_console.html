{% extends "layout.html" %}
{% block title %} Vector Search Console {% endblock %}

{% block content %}
<style>
  pre, code.language-json {
    background: transparent !important;
    box-shadow: none !important;
    text-shadow: none !important;
  }
  /* Remove Prism.js code shadows for all tokens */
  code[class*="language-"], pre[class*="language-"] {
    text-shadow: none !important;
    box-shadow: none !important;
  }
  /* Remove background from Prism.js operator tokens */
  span.token.operator {
    background: transparent !important;
  }
</style>
<div class="container">
  <h5>Vector Search Console</h5>
  <p></p>
  <div class="card caig-card" style="width: 100%;">
    <div class="card-body bg-dark text-light caig-inner-body">
      <form method="post" id="form" name="form" action="/vector_search_console">
        <div class="row align-items-end">
          <div class="col-auto">
            <label class="form-label d-block">Search for:</label>
            <div class="btn-group" role="group" aria-label="Search type">
              <input type="radio" class="btn-check" name="search_type" id="search_entity" autocomplete="off" value="entity" checked>
              <label class="btn btn-sm btn-outline-secondary" for="search_entity">Entity</label>
              
              <input type="radio" class="btn-check" name="search_type" id="search_text" autocomplete="off" value="text">
              <label class="btn btn-sm btn-outline-secondary" for="search_text">Text</label>
            </div>
          </div>
          <div class="col-auto">
            <label class="form-label d-block">Search Method:</label>
            <div class="btn-group" role="group" aria-label="Search method">
              <input type="radio" class="btn-check" name="search_method" id="search_vector" autocomplete="off" value="vector" {{ 'checked' if search_method == 'vector' or not search_method else '' }}>
              <label class="btn btn-sm btn-outline-secondary" for="search_vector">Vector</label>
              
              <input type="radio" class="btn-check" name="search_method" id="search_fulltext" autocomplete="off" value="fulltext" {{ 'checked' if search_method == 'fulltext' else '' }}>
              <label class="btn btn-sm btn-outline-secondary" for="search_fulltext">Full-text</label>
              
              <input type="radio" class="btn-check" name="search_method" id="search_rrf" autocomplete="off" value="rrf" {{ 'checked' if search_method == 'rrf' else '' }}>
              <label class="btn btn-sm btn-outline-secondary" for="search_rrf">RRF</label>
            </div>
          </div>
          <div class="col">
            <label for="entrypoint" class="form-label" id="entrypoint_label">Enter entity name:</label>
            <input type="text" class="form-control" id="entrypoint" name="entrypoint" value='{{ entrypoint }}'
              placeholder="Triple-click for suggestions."/> 
          </div>
          <div class="col-auto">
            <label for="search_limit" class="form-label">Limit:</label>
            <input type="number" class="form-control" id="search_limit" name="search_limit" value='{{ search_limit or 4 }}' 
              min="1" max="100" style="width: 80px;" placeholder="4"/>
          </div>
          <div class="col-auto">
            <label class="form-label d-block">&nbsp;</label>
            <button id="search_button" name="search_button" type="submit" class="btn btn-outline-primary">Search</button>
          </div>
        </div>
        <p class="text-danger fw-bold" id="error_message" name="error_message"></p>
      </form>
    </div>

    {% if results_message or results %}
    <div id="results_div" name="results_div" style="padding: 20px; background-color: rgba(255,255,255,0.03);">
      {% set computed_count = 0 %}
      {% if results %}
      {% set computed_count = results | length %}
      {% endif %}

      <div class="d-flex justify-content-between align-items-center">
        <h5>{{ results_message or "Vector Search Results" }}</h5>
        {% if computed_count and computed_count > 0 %}
        <h6 class="text-muted mb-0">Total Results: {{ computed_count }}</h6>
        {% elif results %}
        <h6 class="text-muted mb-0">Results returned (count not provided)</h6>
        {% endif %}
      </div>
      <pre><code class="language-json">{{ results | tojson | safe }}</code></pre>
          <!-- Prism.js for JSON syntax highlighting -->
          <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet" />
          <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sparql.min.js"></script>
    </div>
    {% endif %}

    {% if embedding_message or embedding %}
    <div class="bg-dark" id="embedding_div" name="embedding_div" style="padding: 20px; border-radius: 8px;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 text-light">{{ embedding_message or "Embedding from Text" }}</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="embedding_toggle_button" name="embedding_toggle_button">Show Embeddings ▼</button>
      </div>
      <div id="embedding_content" name="embedding_content" style="display: none;">
        <pre class="text-light">
        <code>
      {{ embedding }}
        </code>
        </pre>
      </div>
    </div>
    {% endif %}
  </div>
  </div>
</div>

{% endblock %}

{% block js %}
<style>
  /* Search button styling - consistent with Submit button from conv_ai_console.html */
  #search_button {
    background-color: transparent !important;
    border-color: #6c757d !important;
    color: #6c757d !important;
  }
  
  #search_button:hover, 
  #search_button:focus, 
  #search_button.processing {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
  }
  
  #search_button:disabled {
    background-color: transparent !important;
    border-color: #495057 !important;
    color: #495057 !important;
    opacity: 0.6;
  }
  
  /* Active state for toggle buttons */
  .btn-toggle-active {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: white !important;
  }
</style>
<script>
const form = document.getElementById("form");
const search_button = document.getElementById("search_button");
const entrypoint_form_field = document.getElementById("entrypoint");
const entrypoint_label = document.getElementById("entrypoint_label");
const search_entity_radio = document.getElementById("search_entity");
const search_text_radio = document.getElementById("search_text");
const search_vector_radio = document.getElementById("search_vector");
const search_fulltext_radio = document.getElementById("search_fulltext");
const search_rrf_radio = document.getElementById("search_rrf");
const search_limit_field = document.getElementById("search_limit");
const embedding_toggle_button = document.getElementById("embedding_toggle_button");
const embedding_content = document.getElementById("embedding_content");

// Function to get the selected search method from radio buttons
function getSearchMethod() {
  if (search_vector_radio.checked) return 'vector';
  if (search_fulltext_radio.checked) return 'fulltext';
  if (search_rrf_radio.checked) return 'rrf';
  return 'vector'; // default
}

// Function to set the search method radio button
function setSearchMethod(method) {
  search_vector_radio.checked = (method === 'vector');
  search_fulltext_radio.checked = (method === 'fulltext');
  search_rrf_radio.checked = (method === 'rrf');
  
  // If no valid method provided, default to vector
  if (!search_vector_radio.checked && !search_fulltext_radio.checked && !search_rrf_radio.checked) {
    search_vector_radio.checked = true;
  }
}

var suggestions_index = -1;
var entity_suggestions = [
  "flask",
  "pandas",
  "numpy",
  "requests",
  "django"
];

var text_suggestions = [
  "web framework async pydantic",
  "calculations for sports like running, cycling, and swimming",
  "gps file trackpoint garmin connect and garmin devices",
  "machine learning data analysis",
  "http requests and api integration"
];

var current_suggestions = entity_suggestions;

// Update label and suggestions based on search type
function updateSearchType() {
  if (search_entity_radio.checked) {
    entrypoint_label.textContent = "Enter entity name:";
    entrypoint_form_field.placeholder = "Triple-click for suggestions";
    current_suggestions = entity_suggestions;
  } else {
    entrypoint_label.textContent = "Enter search text:";
    entrypoint_form_field.placeholder = "Triple-click for suggestions";
    current_suggestions = text_suggestions;
  }
  suggestions_index = -1; // Reset suggestions index
}

// Add event listeners for radio buttons
search_entity_radio.addEventListener('change', updateSearchType);
search_text_radio.addEventListener('change', updateSearchType);

// Embedding toggle functionality
if (embedding_toggle_button && embedding_content) {
  embedding_toggle_button.addEventListener('click', function(event) {
    event.preventDefault();
    if (embedding_content.style.display === 'none') {
      embedding_content.style.display = 'block';
      embedding_toggle_button.textContent = 'Hide Embeddings ▲';
      embedding_toggle_button.classList.add('btn-toggle-active');
    } else {
      embedding_content.style.display = 'none';
      embedding_toggle_button.textContent = 'Show Embeddings ▼';
      embedding_toggle_button.classList.remove('btn-toggle-active');
    }
  });
}

// Triple-click implementation similar to conv_ai_console.html
let clickCount = 0;
let clickTimer = null;

entrypoint_form_field.addEventListener('click', function (event) {
  clickCount++;
  if (clickCount === 1) {
    clickTimer = setTimeout(function () {
      clickCount = 0;
    }, 400);
  } else if (clickCount === 3) {
    clearTimeout(clickTimer);
    clickCount = 0;
    suggestions_index++;
    if (suggestions_index >= current_suggestions.length) {
      suggestions_index = 0;
    }
    entrypoint_form_field.value = current_suggestions[suggestions_index];
  }
});

search_button.addEventListener('click', 
    function(event) {
      event.preventDefault();
      search_button.disabled = true;
      search_button.classList.add('processing');
      search_button.textContent = "Processing...";
      
      // Store the search query, type, method, and limit in localStorage before submitting
      const entrypoint_value = entrypoint_form_field.value;
      const search_type = search_entity_radio.checked ? 'entity' : 'text';
      const search_method = getSearchMethod();
      const search_limit = search_limit_field.value || '4';
      localStorage.setItem('vector_search_entrypoint', entrypoint_value);
      localStorage.setItem('vector_search_type', search_type);
      localStorage.setItem('vector_search_method', search_method);
      localStorage.setItem('vector_search_limit', search_limit);
      
      // If text search is selected, prefix the value with "text:" for backend compatibility
      if (search_text_radio.checked && entrypoint_value && !entrypoint_value.startsWith('text:')) {
        entrypoint_form_field.value = 'text:' + entrypoint_value;
      }
      
      form.submit();
    }
);

// On page load, restore the search query, type, and method from localStorage
document.addEventListener('DOMContentLoaded', function() {
    // Restore search type
    const saved_search_type = localStorage.getItem('vector_search_type');
    if (saved_search_type === 'text') {
        search_text_radio.checked = true;
    } else {
        search_entity_radio.checked = true;
    }
    updateSearchType();
    
    // Restore search method
    const saved_search_method = localStorage.getItem('vector_search_method');
    if (saved_search_method) {
        setSearchMethod(saved_search_method);
    } else {
        setSearchMethod('vector'); // default to vector if nothing saved
    }
    
    // Restore search limit if not provided by server
    const server_limit = search_limit_field.value.trim();
    if (!server_limit || server_limit === '4') {
        const saved_limit = localStorage.getItem('vector_search_limit');
        if (saved_limit) {
            search_limit_field.value = saved_limit;
        }
    }
    
    // Only restore entrypoint if server didn't provide one
    const server_entrypoint = entrypoint_form_field.value.trim();
    if (!server_entrypoint) {
        const saved_entrypoint = localStorage.getItem('vector_search_entrypoint');
        if (saved_entrypoint) {
            entrypoint_form_field.value = saved_entrypoint;
        }
    } else {
        // If server provided entrypoint with "text:" prefix, clean it up and set the radio button
        if (server_entrypoint.startsWith('text:')) {
            entrypoint_form_field.value = server_entrypoint.substring(5); // Remove "text:" prefix
            search_text_radio.checked = true;
            updateSearchType();
        }
    }
});
</script>
{% endblock %}

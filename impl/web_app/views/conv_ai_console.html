{% extends "layout.html" %}
{% block title %} OmniRAG Chat {% endblock %}

{% block content %}
<div class="container">
  <h5>OmniRAG Chat</h5>
</div>

<form method="post" id="form" name="form" action="/conv_ai_console">
  <input type="hidden" id="conversation_id" name="conversation_id" value="{{ conversation_id }}">

  <div class="container">
    <div class="card caig-card" style="width: 100%;">
      <div class="card-body bg-dark text-light">
        <p class="card-title text-end fw-light fs-6">Conversation ID: {{ conversation_id }}</p>
        <p></p>

        {# Sort primarily by index, with created_at as stable secondary sort #}
        {% set sorted_completions = conv["completions"]|sort(attribute='created_at')|sort(attribute='index') %}
        {% for comp in sorted_completions %}
        {% set content_lines = comp["content"].split("\n") %}
        <div style="background-color: #083a5b; padding: 16px; margin: 0 -1.25rem;">
          <p class="text-start fw-bold fs-6 mb-0" style="color: #79c2ff; margin: 0;">
            {{ comp["user_text"] }}
          </p>
        </div>
        <div style="background-color: #2f3336; padding: 20px; margin: 0 -1.25rem;">
          <div class="text-start fs-6" style="margin: 0;">
            {{ comp["content"] | markdown | safe }}
          </div>
        </div>
        <p class="text-start fw-light fs-6 text-muted mt-2 mb-4">
          Prompt tokens: {{ comp["usage"]["prompt_tokens"] }},
          Completion tokens: {{ comp["usage"]["completion_tokens"] }},
          Total tokens: {{ comp["usage"]["total_tokens"] }},
          RAG strategy: {{ comp["rag_strategy"] }}
        </p>
        {% endfor %}
        <hr>
        <div class="row align-items-end mb-3">
          <div class="col-auto">
            <label class="form-label fs-6 d-block">RAG data source:</label>
            <div class="btn-group" role="group" aria-label="RAG strategy">
              <input type="radio" class="btn-check" name="rag_strategy" id="rag_auto" autocomplete="off" value="auto" {%
                if rag_strategy=='auto' or not rag_strategy %}checked{% endif %}>
              <label class="btn btn-sm btn-outline-secondary" for="rag_auto">Auto</label>

              <input type="radio" class="btn-check" name="rag_strategy" id="rag_db" autocomplete="off" value="db" {% if
                rag_strategy=='db' %}checked{% endif %}>
              <label class="btn btn-sm btn-outline-secondary" for="rag_db">DB</label>

              <input type="radio" class="btn-check" name="rag_strategy" id="rag_vector" autocomplete="off"
                value="vector" {% if rag_strategy=='vector' %}checked{% endif %}>
              <label class="btn btn-sm btn-outline-secondary" for="rag_vector">Vector</label>

              <input type="radio" class="btn-check" name="rag_strategy" id="rag_graph" autocomplete="off" value="graph"
                {% if rag_strategy=='graph' %}checked{% endif %}>
              <label class="btn btn-sm btn-outline-secondary" for="rag_graph">Graph</label>
            </div>
          </div>
          <div class="col">
            <label class="form-label fs-6" for="user_text">Enter your request:</label>
            <input class="form-control" type="text" id="user_text" name="user_text"
              placeholder="Enter your request here. Triple-click for suggestions.">
          </div>
          <div class="col-auto">
            <label class="form-label fs-6 d-block">&nbsp;</label>
            <button type="button" class="btn btn-outline-primary" id="continue_button"
              name="continue_button">Submit</button>
          </div>
        </div>
        <div class="row">
          <div class="col"></div>
          <div class="col-auto text-end">
            <div class="btn-group btn-group-sm" role="group" aria-label="Conversation actions">
              <button type="button" class="btn btn-outline-secondary" id="feedback_button"
                name="feedback_button">Feedback</button>
              <button type="button" class="btn btn-outline-secondary" id="prompts_button"
                name="prompts_button">Prompts</button>
              <button type="button" class="btn btn-outline-secondary" id="json_button" name="json_button">Conversation JSON</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
<div class="container" id="feedback_div" name="feedback_div">
  <br />
  <h5>Feedback</h5>
  <form method="post" id="feedback_form" name="feedback_form" action="/conv_ai_feedback"
    onsubmit="submitForm(); return false;">
    <input type="hidden" id="conversation_id" name="conversation_id" value="{{ conversation_id }}">
    <div>
      <label class="form-label fs-6" for="user_text">Enter your feedback on the last response:</label><br />
      <label class="form-label text-muted">Conversation ID: {{ conversation_id }}</label><br />
      <label class="form-label text-muted">Question: {{ last_user_question }}</label><br />
      <input class="form-control" type="text" id="feedback_user_feedback" name="feedback_user_feedback"
        placeholder="enter your feedback here"><br />
      <div>
        <button type="submit" class="btn btn-outline-primary" id="feedback_submit_button"
          name="feedback_submit_button">Submit</button>
      </div>
    </div>
  </form>
</div>
<div class="container" id="prompts_div" name="prompts_div">
  <hr>
  <h5>Prompts</h5>
  <pre>
  <code>
{{ prompts_text }}
  </code>
  </pre>
</div>

<div class="container" id="conversation_data" name="conversation_data">
  <hr>
  <h5>Conversation JSON</h5>
  <pre>
  <code>
{{ conversation_data }}
  </code>
  </pre>
</div>
{% endblock %}

{% block js %}
<style>
  /* Submit button styling - only highlight on hover/focus/processing */
  #continue_button {
    background-color: transparent !important;
    border-color: #6c757d !important;
    color: #6c757d !important;
  }
  
  #continue_button:hover, 
  #continue_button:focus, 
  #continue_button.processing {
    background-color: rgb(8, 58, 91) !important;
    border-color: rgb(121, 194, 255) !important;
    color: rgb(121, 194, 255) !important;
  }
  
  #continue_button:disabled {
    background-color: transparent !important;
    border-color: #495057 !important;
    color: #495057 !important;
    opacity: 0.6;
  }
  
  /* Active state for toggle buttons */
  .btn-toggle-active {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: white !important;
  }
  /* full-bleed helpers: let background blocks reach the card-body edges while keeping inner content padded */
  .full-bleed {
    width: calc(100% + 2.5rem); /* compensate for .card-body default horizontal padding (1.25rem each side) */
    margin-left: -1.25rem;
    margin-right: -1.25rem;
    box-sizing: border-box;
  }
  .full-bleed .full-bleed-inner {
    padding-left: 1.25rem;
    padding-right: 1.25rem;
  }
</style>
<script>
  const form = document.getElementById("form");
  var user_text = document.getElementById("user_text");
  const continue_button = document.getElementById("continue_button");
  const json_button = document.getElementById("json_button");
  const conversation_data = document.getElementById("conversation_data");
  const feedback_div = document.getElementById("feedback_div");
  const prompts_div = document.getElementById("prompts_div");

  function scrollToBottom() {
    try {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    } catch (e) {
      // no-op
    }
  }

  user_text.focus();
  continue_button.disabled = true;
  conversation_data.style.display = "none";
  feedback_div.style.display = "none";
  prompts_div.style.display = "none";
  // ensure latest completion is visible on render
  document.addEventListener('DOMContentLoaded', scrollToBottom);

  var suggestions_index = -1;
  var suggestions = [
    "what are the dependencies of the python library called flask?",
    "Look up record flask",
    "What are the possible alternatives to it?",
    "Is there an asynchronous version of flask?"
  ];

  let clickCount = 0;
  let clickTimer = null;

  user_text.addEventListener('click', function (event) {
    clickCount++;
    if (clickCount === 1) {
      clickTimer = setTimeout(function () {
        clickCount = 0;
      }, 400);
    } else if (clickCount === 3) {
      clearTimeout(clickTimer);
      clickCount = 0;
      suggestions_index++;
      if (suggestions_index >= suggestions.length) {
        suggestions_index = 0;
      }
      user_text.value = suggestions[suggestions_index];
      continue_button.disabled = false;
    }
  });

  // remove duplicate submit bindings and guard against double submit
  let isSubmitting = false;
  function triggerSubmit() {
    user_text = document.getElementById("user_text");
    if (isSubmitting) {
      return;
    }
    if (user_text && user_text.value.trim().length > 0) {
      isSubmitting = true;
      continue_button.disabled = true;
      continue_button.classList.add('processing');
      continue_button.textContent = "Processing...";
      json_button.disabled = true;
      form.submit();
    }
  }

  continue_button.addEventListener('click', function (event) {
    console.log("continue_button click");
    event.preventDefault();
    triggerSubmit();
  });

  // Submit on Enter key in the text box
  user_text.addEventListener('keydown', function (event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      triggerSubmit();
    }
  });

  feedback_button.addEventListener('click',
    function (event) {
      console.log("feedback_button click");
      event.preventDefault();
      if (feedback_div.style.display == "none") {
        feedback_div.style.display = "block";
        feedback_button.classList.add('btn-toggle-active');
      }
      else {
        feedback_div.style.display = "none";
        feedback_button.classList.remove('btn-toggle-active');
      }
    }
  );

  feedback_submit_button.addEventListener('click',
    function (event) {
      console.log("feedback_submit_button click");
      event.preventDefault();
      submitFeedbackForm();
      feedback_div.style.display = "none";
      feedback_button.classList.remove('btn-toggle-active');
    }
  );

  prompts_button.addEventListener('click',
    function (event) {
      console.log("prompts_button click");
      event.preventDefault();
      if (prompts_div.style.display == "none") {
        prompts_div.style.display = "block";
        prompts_button.classList.add('btn-toggle-active');
      }
      else {
        prompts_div.style.display = "none";
        prompts_button.classList.remove('btn-toggle-active');
      }
    }
  );

  json_button.addEventListener('click',
    function (event) {
      console.log("json_button click");
      event.preventDefault();
      if (conversation_data.style.display == "none") {
        conversation_data.style.display = "block";
        json_button.classList.add('btn-toggle-active');
      }
      else {
        conversation_data.style.display = "none";
        json_button.classList.remove('btn-toggle-active');
      }
    }
  );

  // (kept single handler above)

  user_text.addEventListener("input", () => {
    console.log("user_text: " + user_text.value);
    if (user_text.value.trim().length > 0) {
      continue_button.disabled = false;
    }
    else {
      continue_button.disabled = true;
    }
  });

  function submitFeedbackForm() {
    var http = new XMLHttpRequest();
    http.open("POST", "/conv_ai_feedback", true);
    http.setRequestHeader("Content-type", "application/json");
    postObj = {};
    postObj["conversation_id"] = document.getElementById('conversation_id').value;
    postObj["feedback_last_question"] = "{{ last_user_question }}";
    postObj["feedback_user_feedback"] = document.getElementById('feedback_user_feedback').value;
    console.log("submitFeedbackForm: " + JSON.stringify(postObj));
    http.send(JSON.stringify(postObj));
    http.onload = function () {
      console.log(http.responseText);
      document.getElementById('feedback_user_feedback').value = "";
    }
  }

</script>
{% endblock %}
{% extends "layout.html" %}
{% block title %} Generate SPARQL Console {% endblock %}

{% block content %}
<style>
  pre, code.language-json {
    background: transparent !important;
    box-shadow: none !important;
    text-shadow: none !important;
  }
  /* Remove Prism.js code shadows for all tokens */
  code[class*="language-"], pre[class*="language-"] {
    text-shadow: none !important;
    box-shadow: none !important;
  }
  /* Remove background from Prism.js operator tokens */
  span.token.operator, span.token.punctuation, span.token.url {
    background: transparent !important;
  }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/sparql/sparql.min.js"></script>

<div class="container">
  <h5>Generate SPARQL Console</h5>
  <p></p>

  <form method="post" id="generate_form" name="generate_form" action="/gen_sparql_console_generate_sparql">
    <div class="mb-3">
      <label for="sparql" class="form-label">Enter your request:</label>
      <textarea rows="1" class="form-control" id="natural_language" name="natural_language" 
        placeholder="Triple-click for suggestions.">{{ natural_language }}</textarea>
    </div>
    <div class="mb-6">
      <button type="submit" id="generate_button" name="generate_button" class="btn btn-outline-primary mb-3">Generate SPARQL from Natural Language</button>
    </div>
    <p class="text-danger fw-bold" id="error_message" name="error_message"></p>
  </form>
</div>

<div class="container">
    <p></p>
    <form method="post" id="execute_form" name="execute_form" action="/gen_sparql_console_execute_sparql">
        <div class="mb-3">
            <label for="sparql" class="form-label">SPARQL query:</label>
            <textarea id="sparql" name="sparql">{{ sparql }}</textarea>
            <script>
              var editor = CodeMirror.fromTextArea(document.getElementById("sparql"), {
                mode: "sparql",
                lineNumbers: true,
                theme: "default"
              });
              function resizeCodeMirrorToContent(cm) {
                var doc = cm.getDoc();
                var lineCount = doc.lineCount();
                var newHeight = (lineCount + 1) * 24; // 24px is the default line height
                cm.setSize(null, newHeight + "px");
              }
              resizeCodeMirrorToContent(editor);
              editor.on("change", function(cm) {
                resizeCodeMirrorToContent(cm);
              });
            </script>
        </div>

    <div class="mb-6">
      <button type="submit" id="execute_button" name="execute_button" class="btn btn-outline-primary mb-3">Execute SPARQL Query</button>
    </div>
    <input type="hidden" id="generating_nl" name="generating_nl" value="{{ generating_nl }}">
    <input type="hidden" id="execute_natural_language" name="natural_language" value="{{ natural_language }}">

        <p class="text-danger fw-bold" id="error_message" name="error_message"></p>
    </form>
</div>

<div class="container" id="results_div" name="results_div">
  <h5>{{ results_message }}</h5>
  <pre><code class="language-json">{{ results | tojson | safe }}</code></pre>
  <!-- Prism.js for JSON syntax highlighting -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <br>
  <br>
</div>

<div class="container" id="count_div" name="count_div">
  <h6>Total Results: {{ count }}</h6>
</div>
<p></p>
<p></p>

<div class="container" id="owl_div" name="owl_div">
  <h5>Ontology (OWL/Turtle)</h5>
  <pre><code class="language-turtle">{{ owl }}</code></pre>
  <!-- Prism.js for Turtle syntax highlighting -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-turtle.min.js"></script>
</div>

<!-- see  https://github.com/visjs/vis-network -->
<div class="container" id="ontology_div" name="ontology_div">
  <h5>Ontology Visualization</h5>
  <div class="container" id="ontology_viz" style="width:1024px;height:768px;border: 0px solid lightgray"></div>
</div>
{% endblock %}
{% block js %}
<script>

const nl_form_field   = document.getElementById("natural_language");
const generate_form   = document.getElementById("generate_form");
const generate_button = document.getElementById("generate_button");
const execute_form    = document.getElementById("execute_form");
const execute_button  = document.getElementById("execute_button");

// Triple-click handler for #natural_language
let nl_clickCount = 0;
let nl_clickTimer = null;

nl_form_field.addEventListener('click', function(event) {
  nl_clickCount++;
  if (nl_clickCount === 1) {
    nl_clickTimer = setTimeout(function() {
      nl_clickCount = 0;
    }, 400);
  } else if (nl_clickCount === 3) {
    clearTimeout(nl_clickTimer);
    nl_clickCount = 0;
    nl_query_index++;
    if (nl_query_index >= nl_queries.length) {
      nl_query_index = 0;
    }
    nl_form_field.value = nl_queries[nl_query_index];
    generate_button.disabled = false;
  }
});

var nl_query_index = -1;
var nl_queries = [
  "What is the most connected node?",
  "What entity has the most outgoing connections?",
  "How many nodes are there?",
  "How many connections are there?",
  "What are the dependencies of the flask library?",
  "What are the dependencies of the pandas library?",
  "What are the dependencies of the openai library?", 
  "what 5 libraries have the most dependencies ?"
];


generate_button.addEventListener('click', 
    function(event) {
      event.preventDefault();
      generate_button.disabled = true;
      generate_button.textContent = "Processing...";
      execute_button.disabled = true;
      generate_form.submit();
    }
);


execute_button.addEventListener('click', 
    function(event) {
      event.preventDefault();
      // Sync the current value of the textarea to the hidden input before submit
      document.getElementById('execute_natural_language').value = nl_form_field.value;
      execute_button.disabled = true;
      execute_button.textContent = "Processing...";
      generate_button.disabled = true;
      execute_form.submit();
    }
);




</script>
<!--
This <script> section was generated from an OWL file using this command:
python main_common.py owl_visualizer ontologies/libraries.owl
-->
<script type="text/javascript">

  // create an array with the nodes (i.e. - "entities")
  var nodes = new vis.DataSet([
    { id: "Dev", label: "Dev" },
    { id: "Doc", label: "Doc" },
    { id: "Lib", label: "Lib" }
  ]);

  // create an array with the edges (i.e. - "relationships")
  var edges = new vis.DataSet([
    { from: "Dev", to: "Lib", title: "developer_of" },
    { from: "Lib", to: "Dev", title: "developed_by" },
    { from: "Lib", to: "Lib", title: "used_by_lib, uses_lib" }
  ]);

  var html_container = document.getElementById("ontology_viz");
  var graph_data = { nodes: nodes, edges: edges };
var graph_options = {
    edges: {
      arrows: {
        to: {
          enabled: true,
          scaleFactor: 0.2,
          type: "arrow"
        }
      },
      color: '#A9A9A9',
      font: '12px arial #A9A9A9',
      scaling: {
        label: true,
      },
      shadow: false,
      smooth: true,
    },
    physics:{
      enabled: true,
      repulsion: {
        centralGravity: 0.2,
        springLength: 200,
        springConstant: 0.05,
        nodeDistance: 200,
        damping: 0.09
      }
    }
  };
  var network = new vis.Network(html_container, graph_data, graph_options);
</script>

{% endblock %}
